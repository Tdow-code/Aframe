<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aframe Builder - v49.4 (Delete Frame)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #f3f4f6; print-color-adjust: exact; -webkit-print-color-adjust: exact; }

        /* Status Highlight */
        .status-inactive { background-color: #fef08a !important; border-left: 6px solid #ca8a04 !important; } 

        /* Standard Slab Bar */
        .slab-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1px 4px; margin: 0; 
            border: 1px solid #4b5563; border-left: 6px solid #4b5563; 
            border-radius: 1px; font-size: 0.65rem; height: 19px;
            background: white; position: relative; overflow: hidden;
            box-shadow: 0 1px 0px rgba(0,0,0,0.1); cursor: grab; user-select: none;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        .slab-bar:active { cursor: grabbing; transform: scale(1.02); z-index: 50; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        /* Delete Button on Manual Slabs */
        .delete-btn {
            margin-left: 6px; color: #ef4444; cursor: pointer; font-size: 1rem;
            display: flex; align-items: center; justify-content: center;
            width: 20px; height: 20px; border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
        }
        .delete-btn:hover { background-color: #fee2e2; color: #dc2626; }

        /* A-Frame Spine */
        .a-frame-spine {
            background: repeating-linear-gradient(135deg, #451a03, #451a03 10px, #78350f 10px, #78350f 20px);
            height: 14px; width: 100%; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 900; letter-spacing: 0.2em; border-radius: 0;
            border: 1px solid #000; font-size: 0.5rem; margin: 0;
            z-index: 5;
        }

        /* Truck Layout Grid */
        .truck-bed {
            display: flex; flex-direction: row; 
            gap: 0; background: #f3f4f6; border: 4px solid #1f2937;
            padding: 10px; border-radius: 6px; min-height: 6in; position: relative;
            align-items: stretch; justify-content: space-between;
        }

        /* Cab Indicator */
        .cab-zone {
            width: 40px; min-width: 40px; background: #111827; color: white; 
            display: flex; align-items: center; justify-content: center;
            writing-mode: vertical-rl; text-orientation: mixed;
            font-weight: 900; font-size: 0.9rem; border-right: 2px solid #fff;
            text-transform: uppercase; letter-spacing: 0.1em; height: 100%; z-index: 20;
        }

        /* Tail Indicator */
        .tail-zone {
            width: 40px; min-width: 40px; background: #111827; color: white; 
            display: flex; align-items: center; justify-content: center;
            writing-mode: vertical-rl; text-orientation: mixed;
            font-weight: 900; font-size: 0.9rem; border-left: 2px solid #fff;
            text-transform: uppercase; letter-spacing: 0.1em; height: 100%; z-index: 20;
        }

        /* Bed Area */
        .bed-area {
            flex-grow: 1; display: flex; flex-direction: row; position: relative; width: 100%;
        }

        /* Zones */
        .front-zone {
            flex: 5; display: flex; flex-direction: column; 
            border-right: 4px dashed #9ca3af; position: relative;
            padding: 4px; gap: 8px; justify-content: center;
        }
        
        .rear-zone {
            flex: 7; display: flex; flex-direction: column; 
            position: relative; padding: 4px; gap: 8px; justify-content: center;
        }

        /* Frame Card */
        .frame-card {
            flex: 1; display: flex; flex-direction: column;
            border: 3px solid #374151; background: white;
            border-radius: 4px; padding: 2px; 
            min-height: 0;
        }
        
        /* Frame Header & Remove Button */
        .frame-header {
            background: #374151; color: white; font-weight: 900; 
            text-align: center; font-size: 0.7rem; padding: 2px;
            text-transform: uppercase; letter-spacing: 0.05em;
            position: relative;
        }

        .remove-frame-btn {
            position: absolute; top: 0; right: 0; bottom: 0;
            width: 20px; display: flex; align-items: center; justify-content: center;
            background: #ef4444; color: white; cursor: pointer;
            font-size: 0.7rem; transition: background 0.2s;
        }
        .remove-frame-btn:hover { background: #dc2626; }

        .side-label-top, .side-label-bottom {
            position: absolute; left: 50%; transform: translateX(-50%);
            font-weight: 900; color: #374151; font-size: 1rem; letter-spacing: 0.1em; z-index: 10;
        }
        .side-label-top { top: -25px; }
        .side-label-bottom { bottom: -25px; }

        .side-stats {
            font-size: 0.55rem; font-weight: bold; text-align: center;
            color: #1f2937; background: #e5e7eb; border-bottom: 1px solid #d1d5db; padding: 1px 0;
        }
        
        .slab-container {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
            background: #f9fafb; min-height: 10px; padding: 0;
            transition: background-color 0.2s;
        }
        
        .slab-container.drag-over {
            background-color: #dbeafe; /* Light blue highlight on hover */
            box-shadow: inset 0 0 0 2px #2563eb;
        }

        /* STACKING LOGIC - FLUSH SPINE */
        .stack-up { justify-content: flex-start; flex-direction: column-reverse; } 
        .stack-down { justify-content: flex-start; flex-direction: column; } 

        .badge-locator {
            background-color: #111827; color: #ffffff; font-family: monospace;
            font-weight: 900; padding: 0 4px; border-radius: 2px;
            font-size: 0.55rem; border: 1px solid #000;
        }

        /* Updated Badge Style - Black Circle */
        .badge-stop {
            background-color: #000000; color: #ffffff; font-weight: 900;
            width: 16px; text-align: center; border: 1px solid #000;
            border-radius: 50%; font-size: 0.65rem; line-height: 14px;
            height: 16px; display: inline-block;
        }

        /* Key Badge */
        .key-badge {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 0.7rem; font-weight: bold;
            background-color: #fef08a; border: 1px solid #ca8a04;
            color: #854d0e; padding: 2px 6px; border-radius: 4px;
            margin-left: 8px;
        }

        /* Notifications */
        #notification-area {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px; width: 350px;
        }
        .alert-box {
            padding: 12px; border-radius: 6px; font-size: 0.85rem; font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: flex-start; gap: 10px;
            animation: slideIn 0.3s ease-out;
            background-color: white;
        }
        .alert-error { background-color: #fee2e2; border-left: 6px solid #dc2626; color: #991b1b; }
        .alert-warning { background-color: #fef3c7; border-left: 6px solid #d97706; color: #92400e; }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* MODAL */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px; width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .modal-open { display: flex; }

        @page { size: landscape; margin: 0.15in; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; font-size: 9pt; }
            .truck-bed { border: 4px solid #000; height: 6.5in; width: 100%; }
            .frame-card { border: 3px solid #000; }
            .status-inactive { background-color: #fef08a !important; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .remove-frame-btn { display: none !important; }
        }
        
        .drag-area { border: 2px dashed #ccc; transition: all 0.3s ease; }
        .drag-area.active { border-color: #2563eb; background-color: #eff6ff; }
    </style>
</head>
<body class="p-6 text-gray-800">

    <!-- Notifications -->
    <div id="notification-area" class="no-print"></div>

    <!-- ADD SLAB MODAL -->
    <div id="add-slab-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Add Manual Slab</h2>
            <div class="flex flex-col gap-3">
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-600">Stop Number</label>
                    <input type="number" id="manual-stop" class="border rounded w-full p-2" placeholder="e.g. 1">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-600">Customer</label>
                    <input type="text" id="manual-customer" class="border rounded w-full p-2" placeholder="e.g. New Customer">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-gray-600">Description</label>
                    <input type="text" id="manual-desc" class="border rounded w-full p-2" placeholder="e.g. 3CM White Slab">
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-xs font-bold uppercase text-gray-600">Lot #</label>
                        <input type="text" id="manual-lot" class="border rounded w-full p-2" placeholder="e.g. 123">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold uppercase text-gray-600">Locator</label>
                        <input type="text" id="manual-loc" class="border rounded w-full p-2" placeholder="e.g. A-01">
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 font-bold">Cancel</button>
                    <button onclick="submitManualSlab()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold">Add to Load</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="no-print max-w-4xl mx-auto mb-6">
        <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
            <h1 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-truck-fast text-blue-600"></i> Aframe Builder v49.4
            </h1>
            <div class="flex gap-4 mb-4 items-end">
                <div class="flex-1">
                    <label class="block text-sm font-bold mb-1">Truck Configuration</label>
                    <select class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 bg-white" id="truck-name">
                        <option value="">-- Select a Truck --</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Select a truck configuration from the database.</p>
                </div>
                <div>
                    <button onclick="openModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow flex items-center gap-2">
                        <i class="fas fa-cube"></i> Add Slab
                    </button>
                </div>
            </div>
            
            <!-- CUSTOMER PROFILE UPLOAD -->
            <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-bold text-gray-700">
                        <i class="fas fa-users mr-2 text-blue-600"></i> Customer Profile Database
                    </label>
                    <span id="customer-db-status" class="text-xs font-bold px-2 py-1 rounded bg-gray-200 text-gray-600">
                        Not Loaded
                    </span>
                </div>
                <div id="customer-drop-zone" class="drag-area rounded p-4 text-center cursor-pointer hover:bg-blue-100 transition-colors relative border-2 border-dashed border-blue-300">
                    <p class="text-sm font-bold text-gray-700 pointer-events-none">
                        <i class="fas fa-file-csv mr-2"></i> Upload Customer Profiles.csv
                    </p>
                    <input type="file" id="customer-file-input" accept=".csv,text/csv,application/vnd.ms-excel" class="hidden">
                </div>
                <p class="text-xs text-gray-600 mt-2">Expected columns: Customer Name, Special, Notes, Contact</p>
                <div id="customer-error-msg" class="hidden mt-2 text-sm text-red-600 font-bold"></div>
            </div>

            <!-- LOAD REPORT UPLOAD -->
            <div id="drop-zone" class="drag-area rounded p-8 text-center cursor-pointer hover:bg-gray-50 transition-colors relative">
                <p class="text-lg font-bold text-gray-700 pointer-events-none">
                    <i class="fas fa-cloud-arrow-up mr-2"></i> Upload NEW LOAD REPORT.csv
                </p>
                <!-- Input moved inside but styled to be clickable via label or JS trigger -->
                <input type="file" id="file-input" accept=".csv,text/csv,application/vnd.ms-excel" class="hidden"> 
            </div>

            <div id="error-msg" class="hidden mt-2 text-sm text-red-600 font-bold"></div>
        </div>
    </div>

    <div id="output-container"></div>

    <button onclick="window.print()" id="print-btn" class="hidden no-print fixed bottom-8 right-8 bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg hover:bg-blue-700 font-bold flex items-center gap-2 transition hover:scale-105 z-50 border-2 border-white">
        <i class="fas fa-print"></i> Print Report
    </button>

<script>
    // --- FULL CUSTOMER DATABASE ---
    let CUSTOMER_DB = {};
    
    // Load customer database from localStorage on page load
    function loadCustomerDB() {
        try {
            const stored = localStorage.getItem('customerDB');
            if (stored) {
                CUSTOMER_DB = JSON.parse(stored);
                updateCustomerDBStatus();
                return true;
            }
        } catch (e) {
            console.error('Error loading customer DB from localStorage:', e);
        }
        return false;
    }
    
    // Save customer database to localStorage
    function saveCustomerDB() {
        try {
            localStorage.setItem('customerDB', JSON.stringify(CUSTOMER_DB));
            updateCustomerDBStatus();
            return true;
        } catch (e) {
            console.error('Error saving customer DB to localStorage:', e);
            return false;
        }
    }
    
    // Update UI status indicator
    function updateCustomerDBStatus() {
        const statusEl = document.getElementById('customer-db-status');
        if (!statusEl) return;
        
        const count = Object.keys(CUSTOMER_DB).length;
        if (count > 0) {
            statusEl.textContent = `${count} Customers Loaded`;
            statusEl.className = 'text-xs font-bold px-2 py-1 rounded bg-green-200 text-green-700';
        } else {
            statusEl.textContent = 'Not Loaded';
            statusEl.className = 'text-xs font-bold px-2 py-1 rounded bg-gray-200 text-gray-600';
        }
    }

    // --- STATE MANAGEMENT ---
    let APP_STATE = {
        truckName: "",
        truckConfig: null,
        frames: [],
        stops: [],
        allSlabs: [] // Store original slabs for reset
    };

    // --- DOM ELEMENTS ---
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const outputContainer = document.getElementById('output-container');
    const errorMsg = document.getElementById('error-msg');
    const printBtn = document.getElementById('print-btn');
    const truckInput = document.getElementById('truck-name');
    const notificationArea = document.getElementById('notification-area');
    const customerFileInput = document.getElementById('customer-file-input');
    const customerDropZone = document.getElementById('customer-drop-zone');
    const customerErrorMsg = document.getElementById('customer-error-msg');

    // --- POPULATE TRUCK DROPDOWN ---
    function populateTruckDropdown() {
        if (!truckInput) return;
        truckInput.innerHTML = '<option value="">-- Select a Truck --</option>';
        Object.keys(TRUCK_DB).forEach(key => {
            const config = TRUCK_DB[key];
            const option = document.createElement('option');
            option.value = key;
            option.textContent = `${config.name} - ${config.description}`;
            truckInput.appendChild(option);
        });
    }

    // --- EVENT LISTENERS (FIXED) ---
    // Ensure Click triggers file input
    if (dropZone && fileInput) {
        dropZone.addEventListener('click', (e) => {
            // Don't prevent default if clicking on the file input itself
            if (e.target !== fileInput) {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            }
        });
    }
    
    // Ensure Change triggers handler
    fileInput.addEventListener('change', function(e) {
        if(e.target.files && e.target.files.length > 0) {
            handleFiles(e.target.files);
            // Reset after a short delay to allow re-upload of same file
            setTimeout(() => {
                e.target.value = "";
            }, 100);
        }
    });

    // --- CUSTOMER PROFILE UPLOAD EVENT LISTENERS ---
    if (customerDropZone && customerFileInput) {
        customerDropZone.addEventListener('click', (e) => {
            // Don't prevent default if clicking on the file input itself
            if (e.target !== customerFileInput) {
                e.preventDefault();
                e.stopPropagation();
                customerFileInput.click();
            }
        });
    }
    
    customerFileInput.addEventListener('change', function(e) {
        if(e.target.files && e.target.files.length > 0) {
            handleCustomerFiles(e.target.files);
            setTimeout(() => {
                e.target.value = "";
            }, 100);
        }
    });

    // Customer Drag & Drop
    let customerDragCounter = 0;
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
        customerDropZone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    customerDropZone.addEventListener('dragenter', (e) => {
        customerDragCounter++;
        customerDropZone.classList.add('active');
    });
    customerDropZone.addEventListener('dragleave', (e) => {
        customerDragCounter--;
        if (customerDragCounter === 0) {
            customerDropZone.classList.remove('active');
        }
    });
    customerDropZone.addEventListener('drop', (e) => {
        customerDragCounter = 0;
        customerDropZone.classList.remove('active');
        if (e.dataTransfer.files.length > 0) {
            handleCustomerFiles(e.dataTransfer.files);
        }
    });

    // Drag & Drop Visuals
    let dragCounter = 0;
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
        dropZone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    dropZone.addEventListener('dragenter', (e) => {
        dragCounter++;
        dropZone.classList.add('active');
    });
    dropZone.addEventListener('dragleave', (e) => {
        dragCounter--;
        if (dragCounter === 0) {
            dropZone.classList.remove('active');
        }
    });
    dropZone.addEventListener('drop', (e) => {
        dragCounter = 0;
        dropZone.classList.remove('active');
        if (e.dataTransfer.files.length > 0) {
            handleFiles(e.dataTransfer.files);
        }
    });

    // --- CONFIG ---
    const SLAB_WEIGHTS = {
        '60': { '3': 900, '2': 600, '1': 300 },
        '47': { '3': 700, '2': 460, '1': 230 },
        '30': { '3': 450, '2': 0, '1': 0 } 
    };

    const MAX_WEIGHT_PER_SIDE_DEFAULT = 3600;
    const MAX_CM_PER_SIDE_DEFAULT = 14;
    const MAX_IMBALANCE_THRESHOLD = 1500; 

    const TRUCK_DB = {
        "Metal Aframe Truck": {
            name: "Metal Aframe Truck",
            description: "2-Frame Configuration for Metal Aframe Trucks",
            maxImbalance: 4500,
            frames: [
                { id: 1, zone: 'front', type: 'wood', name: "FRONT MIDDLE (F1)", maxWeight: 7200, maxCm: 14 },
                { id: 2, zone: 'rear', type: 'wood', name: "BACK MIDDLE (F2)", maxWeight: 18000, maxCm: 30 },
            ]
        },
        "SMALL_TRUCK": {
            name: "Small Delivery Truck",
            description: " 2-Frame Configuration for smaller loads",
            frames: [
                { id: 1, zone: 'front', type: 'wood', name: "FRONT MIDDLE (F1)", maxWeight: 7200, maxCm: 14 },
                { id: 2, zone: 'rear', type: 'wood', name: "BACK MIDDLE (F2)", maxWeight: 7200, maxCm: 14 },
            ]
        },
        "Slick Bed Truck": {
            name: "Slick Bed Truck",
            description: "4-Frame Configuration for slick bed trucks",
            frames: [
                { id: 1, zone: 'rear', type: 'wood', name: "BACK RIGHT (F1)", maxWeight: 7200, maxCm: 14 },
                { id: 2, zone: 'rear', type: 'wood', name: "BACK LEFT (F2)", maxWeight: 7200, maxCm: 14 },
                { id: 3, zone: 'front', type: 'wood', name: "FRONT RIGHT (F3)", maxWeight: 7200, maxCm: 14 },
                { id: 4, zone: 'front', type: 'wood', name: "FRONT LEFT (F4)", maxWeight: 7200, maxCm: 14 },
            ]
        }
    };

    // Initialize dropdown on page load (after TRUCK_DB is defined)
    populateTruckDropdown();
    
    // Load customer database from localStorage on page load
    loadCustomerDB();

    // --- CUSTOMER PROFILE HANDLING ---
    function handleCustomerFiles(files) {
        if (files.length === 0) return;
        
        const file = files[0];
        const fileName = file.name.toLowerCase();
        
        // Validate file type
        if (!fileName.endsWith('.csv') && file.type !== 'text/csv' && file.type !== 'application/vnd.ms-excel') {
            customerErrorMsg.textContent = 'Please upload a CSV file (.csv extension).';
            customerErrorMsg.classList.remove('hidden');
            customerFileInput.value = "";
            return;
        }
        
        customerErrorMsg.classList.add('hidden');
        
        // Check if PapaParse is loaded
        if (typeof Papa === 'undefined') {
            customerErrorMsg.textContent = 'Error: PapaParse library not loaded. Please refresh the page.';
            customerErrorMsg.classList.remove('hidden');
            return;
        }
        
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (results.errors.length > 0) {
                    console.error('Customer CSV Parse Errors:', results.errors);
                    customerErrorMsg.textContent = 'CSV parsing error. Please check the file format. See console for details.';
                    customerErrorMsg.classList.remove('hidden');
                } else if (!results.data || results.data.length === 0) {
                    customerErrorMsg.textContent = 'CSV file appears to be empty or has no valid data.';
                    customerErrorMsg.classList.remove('hidden');
                } else {
                    processCustomerData(results.data);
                    customerErrorMsg.classList.add('hidden');
                }
            },
            error: function(error) {
                console.error('Customer CSV Parse Error:', error);
                customerErrorMsg.textContent = 'Error reading CSV file: ' + error.message;
                customerErrorMsg.classList.remove('hidden');
            }
        });
    }

    function processCustomerData(data) {
        const newCustomerDB = {};
        let processedCount = 0;
        let skippedCount = 0;
        
        data.forEach(row => {
            // Try to find customer name in various possible column names
            const customerName = row['Customer Name'] || row['Customer'] || row['Name'] || row['CustomerName'] || '';
            
            if (!customerName || customerName.trim() === '') {
                skippedCount++;
                return;
            }
            
            // Normalize customer name to lowercase for key lookup
            const key = customerName.toLowerCase().trim();
            
            // Get other fields with flexible column name matching
            const special = row['Special'] || row['Special Instructions'] || row['Restrictions'] || row['Restriction'] || '';
            const notes = row['Notes'] || row['Note'] || row['Description'] || '';
            const contact = row['Contact'] || row['Phone'] || row['Phone Number'] || row['Contact Info'] || '';
            
            newCustomerDB[key] = {
                name: customerName.trim(),
                special: (special || '').trim(),
                notes: (notes || '').trim(),
                contact: (contact || '').trim()
            };
            
            processedCount++;
        });
        
        // Merge with existing database (new data takes precedence)
        CUSTOMER_DB = { ...CUSTOMER_DB, ...newCustomerDB };
        
        // Save to localStorage
        if (saveCustomerDB()) {
            showNotification(`Customer database updated: ${processedCount} customers loaded${skippedCount > 0 ? `, ${skippedCount} skipped` : ''}`, 'warning');
        } else {
            showNotification('Customer database loaded but failed to save to browser storage.', 'error');
        }
    }

    // --- LOGIC ---
    function handleFiles(files) {
        if (files.length === 0) return;
        
        const file = files[0];
        const fileName = file.name.toLowerCase();
        
        // Validate file type
        if (!fileName.endsWith('.csv') && file.type !== 'text/csv' && file.type !== 'application/vnd.ms-excel') {
            errorMsg.textContent = 'Please upload a CSV file (.csv extension).';
            errorMsg.classList.remove('hidden');
            fileInput.value = "";
            return;
        }
        
        const truckName = truckInput.value.trim();
        if (!truckName) {
            errorMsg.textContent = 'Please select a Truck Configuration first.';
            errorMsg.classList.remove('hidden');
            truckInput.focus();
            fileInput.value = "";
            return;
        }
        
        APP_STATE.truckName = truckName;
        errorMsg.classList.add('hidden');
        
        // Check if PapaParse is loaded
        if (typeof Papa === 'undefined') {
            errorMsg.textContent = 'Error: PapaParse library not loaded. Please refresh the page.';
            errorMsg.classList.remove('hidden');
            return;
        }
        
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (results.errors.length > 0) {
                    console.error('CSV Parse Errors:', results.errors);
                    errorMsg.textContent = 'CSV parsing error. Please check the file format. See console for details.';
                    errorMsg.classList.remove('hidden');
                } else if (!results.data || results.data.length === 0) {
                    errorMsg.textContent = 'CSV file appears to be empty or has no valid data.';
                    errorMsg.classList.remove('hidden');
                } else {
                    processData(results.data, truckName);
                    errorMsg.classList.add('hidden');
                }
            },
            error: function(error) {
                console.error('CSV Parse Error:', error);
                errorMsg.textContent = 'Error reading CSV file: ' + error.message;
                errorMsg.classList.remove('hidden');
            }
        });
    }

    function parseSlabSpecs(desc) {
        const d = desc.toUpperCase();
        let cm = 3;
        if (d.includes('2CM')) cm = 2;
        if (d.includes('1CM')) cm = 1;

        let size = '60';
        if (d.includes('47') || d.includes('STANDARD')) size = '47';
        if (d.includes('30') || d.includes('HALF')) size = '30';

        let weight = 0;
        if (SLAB_WEIGHTS[size] && SLAB_WEIGHTS[size][cm]) {
            weight = SLAB_WEIGHTS[size][cm];
        } else {
            if (size === '60') weight = cm * 300;
            if (size === '47') weight = cm * 230;
        }
        return { cm, size, weight };
    }

    function cleanDesignName(originalDesc) {
        let name = originalDesc;
        name = name.replace(/3CM 60 Polished Slab/gi, "").trim();
        name = name.replace(/3CM 60 Polished/gi, "").trim(); 
        name = name.replace(/3CM/gi, "").replace(/60/g, "").replace(/Polished/gi, "").replace(/Slab/gi, "").trim();
        let extras = [];
        const upperDesc = originalDesc.toUpperCase();
        if (upperDesc.includes("1CM")) extras.push("1CM");
        if (upperDesc.includes("2CM")) extras.push("2CM"); 
        const finishes = ["Matte", "Satin", "Satin Ridge", "Luxe"];
        finishes.forEach(finish => {
            if (upperDesc.includes(finish.toUpperCase())) {
                extras.push(finish);
            }
        });
        extras.forEach(extra => {
             const regex = new RegExp(extra, "gi");
             name = name.replace(regex, "").trim();
        });
        if (extras.length > 0) {
            return `${name} ${extras.join(" ")}`;
        }
        return name;
    }

    function processData(data, truckName) {
        outputContainer.innerHTML = '';
        errorMsg.classList.add('hidden');
        notificationArea.innerHTML = ''; 
        
        APP_STATE.stops = []; 
        
        let allSlabs = [];

        data.forEach(row => {
            const stopNum = parseInt(row['Stop Number'] || row['Stop'] || 0);
            if (stopNum === 0) return;

            let stopGroup = APP_STATE.stops.find(s => s.number === stopNum);
            if (!stopGroup) {
                stopGroup = {
                    number: stopNum,
                    customer: row['Customer Name'] || 'Unknown',
                    slabs: []
                };
                APP_STATE.stops.push(stopGroup);
            }

            const rawDesc = row['Item Description'] || 'Slab';
            const cleanDesc = cleanDesignName(rawDesc);
            const specs = parseSlabSpecs(rawDesc);
            const lotStatus = row['Lot Status'] || 'Active';
            const isInactive = lotStatus.toUpperCase() !== 'ACTIVE';

            const slabObj = {
                id: crypto.randomUUID(), 
                desc: cleanDesc,
                rawDesc: rawDesc, 
                lot: row['Lot Number'] || '',
                locator: row['Locator'] || '',
                specs: specs,
                stopNumber: stopNum,
                customer: row['Customer Name'] || 'Unknown',
                isInactive: isInactive,
                isManual: false 
            };

            stopGroup.slabs.push(slabObj);
            allSlabs.push(slabObj);
        });

        // Store original for reset
        APP_STATE.allSlabs = allSlabs;

        APP_STATE.stops.sort((a, b) => b.number - a.number);
        // Since we're using a dropdown, the value is the exact key from TRUCK_DB
        // Get first available truck as fallback if none selected
        const fallbackTruck = Object.keys(TRUCK_DB)[0] || null;
        APP_STATE.truckConfig = truckName || fallbackTruck;
        APP_STATE.frames = distributeLoad(allSlabs, truckName); 
        
        validateLoad();
        renderTruck();
        printBtn.classList.remove('hidden');
    }

    // --- RESET LAYOUT LOGIC ---
    window.resetLayout = function() {
        if(confirm("Reset layout to default configuration? This will undo manual frame deletions.")) {
            // Re-distribute using the saved slabs
            const truckName = APP_STATE.truckName;
            APP_STATE.frames = distributeLoad(APP_STATE.allSlabs, truckName);
            validateLoad();
            renderTruck();
        }
    }

    // --- REMOVE FRAME LOGIC ---
    window.removeFrame = function(id) {
        const frame = APP_STATE.frames.find(f => f.id === id);
        if (!frame) return;

        // Prevent deletion if frame has content
        if (frame.driver.length > 0 || frame.passenger.length > 0) {
            alert("Frame must be empty before removing. Please move slabs to another frame or delete them first.");
            return;
        }

        if (confirm(`Remove ${frame.name} from layout?`)) {
            APP_STATE.frames = APP_STATE.frames.filter(f => f.id !== id);
            renderTruck();
        }
    }

    function distributeLoad(slabsQueue, truckName) {
        const configKey = APP_STATE.truckConfig;
        // Ensure config exists, fallback to first available truck
        const fallbackTruck = Object.keys(TRUCK_DB)[0] || null;
        const selectedConfig = TRUCK_DB[configKey] || (fallbackTruck ? TRUCK_DB[fallbackTruck] : null);
        if (!selectedConfig) {
            console.error("No truck configuration found for:", configKey);
            showNotification("Error: Truck configuration not found.", "error");
            return [];
        }
        // Deep copy frames to avoid reference issues on reset
        const truckConfig = JSON.parse(JSON.stringify(selectedConfig));
        
        let frames = truckConfig.frames.map(f => ({
            ...f,
            driver: [],
            passenger: []
        }));

        let backOnlySlabs = [];
        let generalSlabs = [];

        slabsQueue.forEach(slab => {
            const profile = lookupProfile(slab.customer);
            const special = (profile?.special || '').toLowerCase();
            const notes = (profile?.notes || '').toLowerCase();
            
            if (special.includes('back') || notes.includes('back') || 
                special.includes('rear') || notes.includes('rear')) {
                backOnlySlabs.push(slab);
            } else {
                generalSlabs.push(slab);
            }
        });

        const rearLimit = Math.min(frames.length, 2);
        backOnlySlabs.forEach(slab => {
            let bestFrameIndex = -1;
            let bestSide = null;
            
            for (let i = 0; i < rearLimit; i++) {
                const f = frames[i];
                const dStats = getSideStats(f.driver);
                const pStats = getSideStats(f.passenger);
                
                const driverOK = checkFit(dStats, slab, f.maxWeight, f.maxCm);
                const passengerOK = checkFit(pStats, slab, f.maxWeight, f.maxCm);

                if (driverOK && passengerOK) {
                    if (dStats.weight <= pStats.weight) {
                        bestFrameIndex = i; bestSide = 'driver';
                    } else {
                        bestFrameIndex = i; bestSide = 'passenger';
                    }
                    break;
                } else if (driverOK) {
                    bestFrameIndex = i; bestSide = 'driver';
                    break;
                } else if (passengerOK) {
                    bestFrameIndex = i; bestSide = 'passenger';
                    break;
                }
            }

            if (bestFrameIndex !== -1) {
                frames[bestFrameIndex][bestSide].push(slab);
            } else {
                if (frames.length > 0) frames[0].driver.push(slab);
            }
        });

        generalSlabs.forEach(slab => {
            let bestFrameIndex = -1;
            let bestSide = null; 

            for (let i = 0; i < frames.length; i++) {
                const f = frames[i];
                const dStats = getSideStats(f.driver);
                const pStats = getSideStats(f.passenger);

                const driverOK = checkFit(dStats, slab, f.maxWeight, f.maxCm);
                const passengerOK = checkFit(pStats, slab, f.maxWeight, f.maxCm);

                if (driverOK && passengerOK) {
                    if (dStats.weight <= pStats.weight) {
                        bestFrameIndex = i; bestSide = 'driver';
                    } else {
                        bestFrameIndex = i; bestSide = 'passenger';
                    }
                    break; 
                } else if (driverOK) {
                    bestFrameIndex = i; bestSide = 'driver';
                    break;
                } else if (passengerOK) {
                    bestFrameIndex = i; bestSide = 'passenger';
                    break;
                }
            }

            if (bestFrameIndex !== -1) {
                frames[bestFrameIndex][bestSide].push(slab);
            } else {
                if(frames.length > 0) frames[0].driver.push(slab);
            }
        });

        return frames;
    }

    function getSideStats(stack) {
        let weight = 0;
        let cm = 0;
        stack.forEach(s => { weight += s.specs.weight; cm += s.specs.cm; });
        return { weight, cm, count: stack.length };
    }

    function checkFit(currentStats, newSlab, maxWeight = MAX_WEIGHT_PER_SIDE_DEFAULT, maxCm = MAX_CM_PER_SIDE_DEFAULT) {
        const sideWeightLimit = maxWeight / 2;
        if (currentStats.weight + newSlab.specs.weight > sideWeightLimit) return false;
        if (currentStats.cm + newSlab.specs.cm > maxCm) return false;
        if (currentStats.count + 1 > 14) return false; 
        return true;
    }

    // --- DRAG AND DROP ---
    let draggedSlab = null;
    let sourceFrameId = null;
    let sourceSide = null;

    window.onDragStart = function(event, frameId, side, slabId) {
        draggedSlab = slabId;
        sourceFrameId = frameId;
        sourceSide = side;
        event.dataTransfer.effectAllowed = "move";
        const frame = APP_STATE.frames.find(f => f.id === frameId);
        const slab = frame[side].find(s => s.id === slabId);
        event.dataTransfer.setData("text/plain", JSON.stringify(slab));
        setTimeout(() => event.target.classList.add('opacity-50'), 0);
    };

    window.onDragEnd = function(event) {
        event.target.classList.remove('opacity-50');
        draggedSlab = null;
        document.querySelectorAll('.slab-container').forEach(el => el.classList.remove('drag-over'));
    };

    window.onDragOver = function(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = "move";
        const container = event.target.closest('.slab-container');
        if (container) container.classList.add('drag-over');
    };

    window.onDragLeave = function(event) {
        const container = event.target.closest('.slab-container');
        if (container) container.classList.remove('drag-over');
    };

    window.onDrop = function(event, targetFrameId, targetSide) {
        event.preventDefault();
        const container = event.target.closest('.slab-container');
        if (container) container.classList.remove('drag-over');

        if (!draggedSlab) return;

        const srcFrame = APP_STATE.frames.find(f => f.id === sourceFrameId);
        const slabIndex = srcFrame[sourceSide].findIndex(s => s.id === draggedSlab);
        if (slabIndex === -1) return;
        
        const [movedSlab] = srcFrame[sourceSide].splice(slabIndex, 1);

        const tgtFrame = APP_STATE.frames.find(f => f.id === targetFrameId);
        tgtFrame[targetSide].push(movedSlab);

        validateLoad();
        renderTruck();
    };

    // --- MANUAL ADD / DELETE ---
    function openModal() {
        document.getElementById('add-slab-modal').classList.add('modal-open');
    }

    function closeModal() {
        document.getElementById('add-slab-modal').classList.remove('modal-open');
        ['manual-stop', 'manual-customer', 'manual-desc', 'manual-lot', 'manual-loc'].forEach(id => document.getElementById(id).value = '');
    }

    function deleteSlab(frameId, side, slabId) {
        const frame = APP_STATE.frames.find(f => f.id === frameId);
        const slabIndex = frame[side].findIndex(s => s.id === slabId);
        if (slabIndex > -1) {
            const slab = frame[side][slabIndex];
            if (!slab.isManual) {
                alert("Cannot delete slabs from CSV.");
                return;
            }
            
            frame[side].splice(slabIndex, 1);
            
            const stopGroup = APP_STATE.stops.find(s => s.number === slab.stopNumber);
            if (stopGroup) {
                stopGroup.slabs = stopGroup.slabs.filter(s => s.id !== slab.id);
                if (stopGroup.slabs.length === 0) {
                    APP_STATE.stops = APP_STATE.stops.filter(s => s.number !== slab.stopNumber);
                }
            }

            validateLoad();
            renderTruck();
        }
    }

    function submitManualSlab() {
        const stopNum = parseInt(document.getElementById('manual-stop').value) || 0;
        const customer = document.getElementById('manual-customer').value || "Unknown";
        const rawDesc = document.getElementById('manual-desc').value || "Slab";
        const lot = document.getElementById('manual-lot').value || "";
        const locator = document.getElementById('manual-loc').value || "";

        if (stopNum <= 0) { alert("Please enter a valid stop number."); return; }

        const cleanDesc = cleanDesignName(rawDesc);
        const specs = parseSlabSpecs(rawDesc);
        
        const newSlab = {
            id: crypto.randomUUID(),
            desc: cleanDesc,
            rawDesc: rawDesc,
            lot: lot,
            locator: locator,
            specs: specs,
            stopNumber: stopNum,
            customer: customer,
            isInactive: false,
            isManual: true 
        };

        // Stop Insertion Logic
        let existingStop = APP_STATE.stops.find(s => s.number === stopNum);
        let isInsertion = false;

        if (existingStop) {
            const existingName = existingStop.customer.toLowerCase().trim();
            const newName = customer.toLowerCase().trim();
            if (!existingName.includes(newName) && !newName.includes(existingName)) {
                isInsertion = true;
            }
        }

        if (isInsertion) {
            APP_STATE.stops.forEach(s => {
                if (s.number >= stopNum) {
                    s.number += 1;
                    s.slabs.forEach(sl => sl.stopNumber += 1);
                }
            });
            APP_STATE.stops.push({
                number: stopNum,
                customer: customer,
                slabs: [newSlab]
            });
            showNotification(`Inserted Stop #${stopNum}. Subsequent stops shifted.`, 'warning');
        } else {
            if (existingStop) {
                existingStop.slabs.push(newSlab);
            } else {
                APP_STATE.stops.push({
                    number: stopNum,
                    customer: customer,
                    slabs: [newSlab]
                });
            }
        }

        APP_STATE.stops.sort((a, b) => b.number - a.number);

        // Greedy Add
        const profile = lookupProfile(customer);
        const special = (profile?.special || '').toLowerCase();
        const notes = (profile?.notes || '').toLowerCase();
        const isBackOnly = special.includes('back') || notes.includes('back') || special.includes('rear');

        let targetFramesIndices = [0, 1, 2, 3];
        if (isBackOnly) targetFramesIndices = [0, 1]; 

        let inserted = false;
        for (let i of targetFramesIndices) {
            if (i >= APP_STATE.frames.length) continue;
            const f = APP_STATE.frames[i];
            const dStats = getSideStats(f.driver);
            const pStats = getSideStats(f.passenger);
            
            const driverOK = checkFit(dStats, newSlab, f.maxWeight, f.maxCm);
            const passengerOK = checkFit(pStats, newSlab, f.maxWeight, f.maxCm);

            if (driverOK && passengerOK) {
                if (dStats.weight <= pStats.weight) f.driver.push(newSlab);
                else f.passenger.push(newSlab);
                inserted = true; break;
            } else if (driverOK) {
                f.driver.push(newSlab);
                inserted = true; break;
            } else if (passengerOK) {
                f.passenger.push(newSlab);
                inserted = true; break;
            }
        }

        if (!inserted) {
            if (APP_STATE.frames.length > 0) {
                APP_STATE.frames[0].driver.push(newSlab);
                showNotification("Slab forced into Frame 1 (Truck Full)", "error");
            }
        }

        closeModal();
        validateLoad();
        renderTruck();
    }

    // --- VALIDATION & NOTIFICATIONS ---
    function showNotification(msg, type) {
        const div = document.createElement('div');
        div.className = `alert-box ${type === 'error' ? 'alert-error' : 'alert-warning'}`;
        div.innerHTML = `<i class="fas ${type === 'error' ? 'fa-circle-exclamation' : 'fa-triangle-exclamation'} text-xl mt-1"></i><span>${msg}</span>`;
        notificationArea.appendChild(div);
        setTimeout(() => {
            div.style.opacity = '0';
            setTimeout(() => div.remove(), 300);
        }, 8000);
    }

    function validateLoad() {
        notificationArea.innerHTML = ''; 
        
        // Get truck-specific imbalance threshold if available
        const truckConfigKey = APP_STATE.truckConfig || APP_STATE.truckName;
        const truckConfig = truckConfigKey ? TRUCK_DB[truckConfigKey] : null;
        const imbalanceThreshold = truckConfig?.maxImbalance || MAX_IMBALANCE_THRESHOLD;
        
        APP_STATE.frames.forEach(frame => {
            const dStats = getSideStats(frame.driver);
            const pStats = getSideStats(frame.passenger);
            const totalWeight = dStats.weight + pStats.weight;
            const maxFrameWeight = frame.maxWeight || 7200;
            const maxSideCm = frame.maxCm || 14;

            if (totalWeight > maxFrameWeight) {
                showNotification(`Frame ${frame.name} OVERLOADED! ${totalWeight}lbs > ${maxFrameWeight}lbs limit.`, 'error');
            }
            if (dStats.cm > maxSideCm) showNotification(`Frame ${frame.name} (Driver) Width Exceeded! ${dStats.cm}cm > ${maxSideCm}cm.`, 'error');
            if (pStats.cm > maxSideCm) showNotification(`Frame ${frame.name} (Pass) Width Exceeded! ${pStats.cm}cm > ${maxSideCm}cm.`, 'error');

            const diff = Math.abs(dStats.weight - pStats.weight);
            if (diff > imbalanceThreshold) {
                showNotification(`Frame ${frame.name} Imbalanced! ${diff}lbs difference > ${imbalanceThreshold}lbs limit.`, 'warning');
            }

            [...frame.driver, ...frame.passenger].forEach(slab => {
                const profile = lookupProfile(slab.customer);
                const special = (profile?.special || '').toLowerCase();
                const notes = (profile?.notes || '').toLowerCase();
                const isRestricted = special.includes('back') || notes.includes('back') || special.includes('rear');

                if (isRestricted && frame.zone === 'front') {
                    showNotification(`RESTRICTION: ${slab.customer} is on FRONT frame but requires BACK/REAR.`, 'error');
                }
            });
        });
    }

    function renderTruck() {
        const truckConfigKey = APP_STATE.truckName;
        const fallbackTruck = Object.keys(TRUCK_DB)[0] || null;
        const truckConfig = TRUCK_DB[truckConfigKey] || (fallbackTruck ? TRUCK_DB[fallbackTruck] : null);
        const truckDisplayName = truckConfig ? truckConfig.name : truckConfigKey;
        const aFrames = APP_STATE.frames;
        const stopsArr = APP_STATE.stops;
        
        let totalSlabs = 0;
        aFrames.forEach(f => totalSlabs += (f.driver.length + f.passenger.length));

        const rearFrames = aFrames.filter(f => f.zone === 'rear');
        const frontFrames = aFrames.filter(f => f.zone === 'front');

        let html = `
            <div class="truck-card bg-white mx-auto p-4 relative h-full flex flex-col">
                <div class="flex justify-between items-center border-b-4 border-gray-800 pb-4 mb-4">
                    <div>
                        <h1 class="text-3xl font-black text-gray-900 uppercase tracking-tight">Truck: ${truckDisplayName}</h1>
                        <div class="text-sm font-bold text-gray-600">Date: ${new Date().toLocaleDateString()}</div>
                    </div>
                    <div class="flex items-center gap-4 text-right">
                        <div class="key-badge">Fab Only</div>
                        <div class="text-2xl font-black">${totalSlabs} Slabs</div>
                        <div class="text-sm font-bold text-blue-800 bg-blue-100 px-3 py-1 rounded border border-blue-300">${aFrames.length} Frames Config</div>
                        <button onclick="resetLayout()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded text-xs flex items-center gap-1 no-print">
                            <i class="fas fa-rotate-left"></i> Reset Layout
                        </button>
                    </div>
                </div>

                <div class="truck-bed">
                    <div class="cab-zone">FRONT (CAB)</div>
                    
                    <div class="bed-area">
                        
                        <div class="side-label-top">PASSENGER SIDE</div>
                        <div class="side-label-bottom">DRIVER SIDE</div>
                        
                        <!-- FRONT ZONE (Left) -->
                        <div class="front-zone">
                            <div class="zone-bg-label">FRONT</div>
                             ${frontFrames.length === 0 ? '<div class="m-auto text-gray-300 font-bold text-xl z-10">EMPTY ZONE</div>' : ''}
                             ${frontFrames.map(frame => renderFrameCard(frame)).join('')}
                        </div>

                        <!-- REAR ZONE (Right) -->
                        <div class="rear-zone">
                            <div class="zone-bg-label">REAR</div>
                             ${rearFrames.length === 0 ? '<div class="m-auto text-gray-300 font-bold text-xl z-10">EMPTY ZONE</div>' : ''}
                             ${rearFrames.map(frame => renderFrameCard(frame)).join('')}
                        </div>

                    </div>

                    <div class="tail-zone">REAR (TAIL)</div>
                </div>

                <div class="mt-8">
                    <table class="w-full text-xs border-collapse manifest-table border-2 border-black">
                        <thead>
                            <tr class="bg-black text-white text-left">
                                <th class="p-2 w-10 text-center border-r border-white">#</th>
                                <th class="p-2 border-r border-white">Customer</th>
                                <th class="p-2 w-12 text-center border-r border-white">Qty</th>
                                <th class="p-2">Notes / Restrictions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stopsArr.map(stop => {
                                const profile = lookupProfile(stop.customer);
                                const notes = profile ? profile.notes : "";
                                const contact = profile ? profile.contact : "";
                                const special = (profile?.special || '').toLowerCase();
                                const isHeavy = special.includes('call') || special.includes('back') || special.includes('outside') || special.includes('gate') || notes.toLowerCase().includes('back');
                                return `
                                    <tr class="border-b border-black ${isHeavy ? 'bg-red-50' : ''}">
                                        <td class="p-2 text-center font-black border-r border-black text-sm">${stop.number}</td>
                                        <td class="p-2 font-bold border-r border-black uppercase text-xs">${stop.customer}</td>
                                        <td class="p-2 text-center font-black border-r border-black text-sm">${stop.slabs.length}</td>
                                        <td class="p-2 font-bold text-xs">
                                            <span class="${isHeavy ? 'text-red-700' : 'text-gray-800'}">${notes}</span>
                                            <span class="ml-2 text-gray-600">${contact}</span>
                                        </td>
                                    </tr>
                                    `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        outputContainer.innerHTML = html;
    }

    function renderFrameCard(frame) {
        const sortSlabs = (a, b) => b.stopNumber - a.stopNumber;
        const driverSlabs = frame.driver.slice().sort(sortSlabs);
        const passSlabs = frame.passenger.slice().sort(sortSlabs);

        const dStats = getSideStats(frame.driver);
        const pStats = getSideStats(frame.passenger);
        
        return `
            <div class="frame-card">
                <div class="frame-header">
                    ${frame.name}
                    <div class="remove-frame-btn" onclick="removeFrame(${frame.id})" title="Remove Frame (Must be empty)">
                        <i class="fas fa-trash-can"></i>
                    </div>
                </div>
                
                <!-- PASSENGER SIDE (Top) -->
                <div class="side-stats">R: ${pStats.weight}lbs</div>
                <div class="slab-container stack-up border-b-2 border-black"
                     ondragover="onDragOver(event)" 
                     ondrop="onDrop(event, ${frame.id}, 'passenger')"
                     ondragleave="onDragLeave(event)">
                    ${passSlabs.map(slab => renderSlabBar(slab, frame.id, 'passenger')).join('')}
                </div>

                <!-- SPINE -->
                <div class="a-frame-spine">SPINE</div>

                <!-- DRIVER SIDE (Bottom) -->
                <div class="slab-container stack-down"
                     ondragover="onDragOver(event)" 
                     ondrop="onDrop(event, ${frame.id}, 'driver')"
                     ondragleave="onDragLeave(event)">
                    ${driverSlabs.map(slab => renderSlabBar(slab, frame.id, 'driver')).join('')}
                </div>
                <div class="side-stats">L: ${dStats.weight}lbs</div>
            </div>
        `;
    }

    function renderSlabBar(slab, frameId, side) {
        let bgClass = ''; 
        if (slab.isInactive) bgClass = 'status-inactive'; 

        const lotDisplay = slab.lot.length > 3 ? slab.lot.slice(-3) : slab.lot;
        const tooltip = `${slab.rawDesc} | Status: ${slab.isInactive ? 'INACTIVE' : 'Active'}`;

        const deleteBtnHtml = slab.isManual 
            ? `<div class="delete-btn" onclick="deleteSlab(${frameId}, '${side}', '${slab.id}')" title="Delete Slab"><i class="fas fa-trash-can"></i></div>`
            : '';

        return `
            <div class="slab-bar ${bgClass} hover:bg-white" title="${tooltip}"
                 draggable="true"
                 ondragstart="onDragStart(event, ${frameId}, '${side}', '${slab.id}')"
                 ondragend="onDragEnd(event)">
                <div class="flex items-center w-1/3 overflow-hidden gap-1 pointer-events-none">
                    <span class="badge-stop">${slab.stopNumber}</span>
                    <span class="badge-locator ml-1">${slab.locator}</span>
                </div>
                <div class="flex-1 text-center truncate font-black px-1 text-black text-[0.65rem] uppercase tracking-tight pointer-events-none">${slab.desc}</div>
                <div class="flex items-center justify-end w-1/6 gap-1 pointer-events-none">
                    <span class="text-black font-bold font-mono text-[0.65rem]">..${lotDisplay}</span>
                </div>
                ${deleteBtnHtml}
            </div>
        `;
    }

    function lookupProfile(name) {
        if (!name) return null;
        const n = name.toLowerCase().trim();
        
        if (CUSTOMER_DB[n]) return CUSTOMER_DB[n];

        for(let key in CUSTOMER_DB) {
            if (n.includes(key) || key.includes(n)) return CUSTOMER_DB[key];
        }
        return null;
    }
</script>
</body>
</html>